pico-8 cartridge // http://www.pico-8.com
version 32
__lua__
-- main gameplay
black,dark_blue,dark_purple,dark_green,brown,dark_gray,light_gray,white,red,orange,yellow,green,blue,indigo,pink,peach=0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15
_debug = ""

function _init()
    kiki = {
        dy= 0,
        dx= 0,
        x= 50,
        y= 50, 
        mirror= false,
        drop_cd= 0,
        dash_cd= 0,
        drop_done=true,
        carry_weight=4,
    }

    cam = {
        x=0,
        y=0,
        max_dx=7,
        offset_x=64,
        offset_y=0,
    }

    pickups = {100}
    dropoffs = {20}

    frames = 0 
    air_resistance, acc, gravity = 0.95, 0.3, 0.1

    update_fn = update_main_menu
    draw_fn = draw_main_menu
end

function _update60()
    update_fn()
end

function _draw()
    draw_fn()
end

-->8
-- gameplay
function update_gameplay()
    frames += 1
    local move = false
    if btn(⬅️) then
        kiki["dx"] -= acc 
        kiki["mirror"] = false
        move = true
    end
    if btn(➡️) then
        kiki["dx"] += acc 
        kiki["mirror"] = true
        move = true
    end
    if btn(⬇️) then
        kiki["dy"] += acc/2
    end
    if btn(⬆️) then
        kiki["dy"] -= acc/2
    end

    -- drop
    kiki["drop_cd"] -= 1
    if btnp(🅾️) and kiki["drop_cd"] <= 0 and kiki["drop_done"] then
        kiki["dy"] = 4
        kiki["drop_cd"] = 30
        kiki["drop_done"] = false
    end
    if btn(🅾️) then
        kiki["dx"] *= 0.2
    end
    if not btn(🅾️) then
        kiki["drop_done"] = true
    end

    -- dash
    kiki["dash_cd"] -= 1
    if btnp(❎) and kiki["dash_cd"] <= 0 then
        if kiki["mirror"] then
            kiki["dx"] = 10
        else
            kiki["dx"] = -10
        end
        kiki["dash_cd"] = 60
    end

    kiki["dx"] *= air_resistance
    kiki["dy"] *= air_resistance
    if kiki["y"] < 0 then
        kiki["dy"] += gravity
    end

    -- set kiki position
    kiki["x"] += kiki["dx"]
    kiki["y"] += kiki["dy"]
    if kiki["y"] > 110 and kiki["dy"] >= 0 then
        kiki["dy"] *= 0.2
        kiki["dx"] *= 0.2
    end

    -- set camera position
    move_camera(kiki["x"], kiki["y"], not move, kiki["mirror"])

    -- add in new pickup and drop off's randomly
    -- TODO: don't spawn too close to the player
    -- TODO: make sure to spawn the drop off spot a little ways from the player
    -- TODO: don't spawn pickup and drop off spots too close to each other
    if flr(rnd(60 * 2)) == 1 then
        add(pickups, rnd(4096))
        add(dropoffs, rnd(4096))
    end
    
    -- check pickup/ dropoff
    local pickup, dropoff = check_pickup(), check_dropoff()
    if pickup > 0 then
        deli(pickups, pickup)
        kiki["carry_weight"] += 1
    end
    if dropoff > 0 then
        deli(dropoffs, dropoff)
        kiki["carry_weight"] -= 1
    end
end

function check_pickup()
    local dist = 10
    for i, pickup in ipairs(pickups) do
        if kiki["y"] > 100 and kiki["x"] + 4 > pickup - dist and kiki["x"] + 4 < pickup + 8 + dist then
            return i
        end
    end
    return -1
end

function check_dropoff()
    local dist = 10
    for i, dropoff in ipairs(dropoffs) do
        if kiki["y" > 100 and kiki["x"] + 4 > dropoff - dist and kiki["x"] + 4 < dropoff + 8 + dist then
            return i
        end
    end
    return -1
end

function draw_gameplay()
    cls(blue)

    -- draw the ui
    camera(0, 0)
    draw_dash_ui()
    draw_weight_ui()
    print(_debug, 5, 15, red)
    _debug = ""

    camera(cam["x"], cam["y"])

    -- draw the map. we'll probably end up wanting to use one of these sections
    -- for the paralax bg. It will be ok to repeat it more because it will scroll much
    -- more slowly
    map(0, 0, 0, 64, 128, 8)
    map(0, 8, 1024, 64, 128, 8)
    map(0, 16, 2048, 64, 128, 8)
    map(0, 24, 3072, 64, 128, 8)

    -- draw pickup/ dropoff
    for _, pickup in ipairs(pickups) do
        spr(11, pickup, 100)
    end
    for _, dropoff in ipairs(dropoffs) do
        spr(12, dropoff, 100)
    end

    palt(blue, true)
    spr(1, kiki["x"], kiki["y"]+sin(frames/60)*1.5, 1, 1, kiki["mirror"], false)
end

function move_camera(x, y, center, face_right)
    -- choose the x goal point for the camera
    if center then
        cam["offset_x"] += (cam["offset_x"] - 64) * -0.05
        goal_x = x - cam["offset_x"]
    end
    if not center and face_right then
        cam["offset_x"] += (cam["offset_x"] - 10) * -0.1
        goal_x = x - cam["offset_x"]
    end
    if not center and not face_right then
        cam["offset_x"] += (cam["offset_x"] - 110) * -0.1
        goal_x = x - cam["offset_x"]
    end

    -- move towards the x goal point
    local cam_dx = (cam["x"] - goal_x) * -0.3
    if cam_dx > cam["max_dx"] then
        cam_dx = cam["max_dx"]
    end
    if cam_dx < -cam["max_dx"] then
        cam_dx = -cam["max_dx"]
    end

    -- set camera x
    cam["x"] += cam_dx

    -- set camera y
    cam["y"] += (cam["y"] - (y - 20)) * -0.05
    if cam["y"] > 0 then
        cam["y"] = 0
    end
end

-->8
-- main menu
function update_main_menu()
    if btnp(❎) or btnp(🅾️) then
        draw_fn = draw_gameplay
        update_fn = update_gameplay
    end
end

function draw_main_menu()
    cls(blue)
    print("kiki's delivery service", 18, 20, red)

    print("press ❎/🅾️ to start", 22, 90, red)
end

-->8
-- ui
function draw_dash_ui()
    if kiki["dash_cd"] <= 0 then
        spr(13, 5, 5)
    end
end

function draw_weight_ui()
    for i=1,kiki["carry_weight"],1 do
        spr(14, 100+i*4, 5)
    end
end

__gfx__
00000000cccccccccccccccccccccccbccccc777777cccccccccccccccccccccccbbbbcc7777777777777777ccaaaacccc2222cc000000000000000000000000
00000000c888cccccccccccccccccbbbccc7777777777ccccccccccccccccccccbbbbbbc7777777777777777caaaaaac22222222088000000888000000000000
00000000c88888cccbbbbbbcccccbbbbcc777777777777cccc0c0cccccccccccbbbbbbbb77777777f7777777aaaaaaaa24422242088800000888000000000000
00000000cc8888ccbbbbbbbbbbbbbbbbc77777777777777ccc0c0cccc00c00ccbbbbbbbb77777777f77ff777aaaaaaaa24444242088880000888000000000000
00000000cc88888cbbbbbbbbbbbbbbbbc77777777777777cccc0ccccccc0cccc3bbbbbb377777777f77fffffaaaaaaaa24444442088880000888000000000000
00000000cc888888bbbbbbbbbbbbbbbb7777777777777777cccccccccccccccc33bbbb3377777777ffffffffaaaaaaaa24444242088800000888000000000000
0000000088888888bbbbbbbbbbbbbbbb7777777777777777ccccccccccccccccc333333c77777777ffffffffcaaaaaac22244422088000000888000000000000
00000000cccccccccbbbbbbccccccccc7777777777777777cccccccccccccccccc3333cc77777777ffffffffccaaaacccc2222cc000000000000000000000000
000000000000000000000000000000007777777777777777000000000000000000000000ffffffff777777770000000000000000000000000000000000000000
00000000000000000000000000000000f77777777777777f000000000000000000000000ffffffff777777770000000000000000000000000000000000000000
00000000000000000000000000000000ff777777777777ff000000000000000000000000ffffffff777777770000000000000000000000000000000000000000
00000000000000000000000000000000cff7777777777ffc000000000000000000000000fffffffff77777770000000000000000000000000000000000000000
00000000000000000000000000000000cffff777777ffffc000000000000000000000000fffffffff77777770000000000000000000000000000000000000000
00000000000000000000000000000000ccffffffffffffcc000000000000000000000000fffffffff77777770000000000000000000000000000000000000000
00000000000000000000000000000000cccffffffffffccc000000000000000000000000fffffffff77f777f0000000000000000000000000000000000000000
00000000000000000000000000000000cccccffffffccccc000000000000000000000000ffffffffff7fffff0000000000000000000000000000000000000000
__map__
0900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0900000000000000000000000000000000090a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0900000000000000000000000000000000191a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
09000000090a0000090a00000000000000090a090a0000000000000000000000090a090a00000000000000090a000000090a0000000000000000090a0000000000000000090a090a090a0000090a090a090a00090a0000090a090a0000000000000000000000090a090a000000090a00000000090a0000090a090a0000000000
09000000191a0000191a00000000000000191a191a0000000000000000000000191a191a00000000000000191a000000191a090a090a090a090a19090a090a090a000000191a191a191a0000191a191a191a00191a0000191a191a0000000000000000000000191a191a000000191a00000000191a0000191a191a0000000000
090a090a090a090a09090a090a090a090a090a090a090a090a090a09090a090a090a09090a090a090a09090a090a090a090a191a090a090a090a0919090a090a090a090a090a090a090a090a090a090a09090a090a090a090a090a090a090a090a090a09090a090a09090a090a090a090a090a090a090a090a09090a090a090a
191a191a191a191a19191a191a191a191a191a191a191a191a191a19191a191a191a19191a191a191a19191a191a191a191a191a191a191a191a191a191a191a191a191a191a191a191a191a191a191a19191a191a191a191a191a191a191a191a191a19191a191a19191a191a191a191a191a191a191a191a19191a191a191a
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000090a090a090a00000000000000000000000000000009090a090a0000000000000000000000000000000000090a090a0000000000000000000000000000000000090a0000000000000000000000000000000000000000000000090a00000000090a0000000000000000000000000000000000090a00000000000000
0000000000191a191a191a00000000000000000000090a090a090a191a191a0000000000000000090a090a0000000000191a191a0000000000000009090a0a090a090a0a00191a00090a090a090a090a00000000090a090a000000000000191a00000000191a00000000090a090a000000000000000000191a00000000000000
090a09090a090909090909090a0a090a090a090a09191a191a191a090909090a0a0a090a090a09191a191a090a090a09090a090a090a09090a090a19090a090a09191a0a0a090a09191a191a191a19090a090a09191a191a0a090a090a0909090a0a090a09090909090a191a191a090a090a090a090a0909090a090a090a090a
191a19191a191919191919191a1a191a191a191a191a191a191a19191919191a1a1a191a191a191a191a19191a191a19191a191a191a19191a191a19191a191a191a191a1a191a191a191a191a191a191a191a191a191a191a191a191a1919191a1a191a19191919191a191a191a191a191a191a191a1919191a191a191a191a
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000090a000000000000090a000000090a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000191a090a00000000191a000000191a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000090a000000000000090a00000000090a090a0000000000090a0000090a0000000000090a090a00000000000009090a191a00000000090a000000090a0000000000000000090a000000000000000000000000000000000000000000000000000000000000090a000000000000090a090a000000000000090a000000
0000000000191a000000000000191a00000000191a191a0000000000191a0000191a0000000000191a191a00000000000019090a090a00000000191a000000191a090a090a090a0009191a0a090a090a00000000000000090a090a090a090a00000000000000000000191a000000000000191a191a000000000000191a000000
09090a090a090a090a090a090a090a090a090a090a09090a090a090a090a090a09090a090a090a090a090a090a090a090a0919090a0a090a090a09090a090a090a090a090a090a0919090a090a090a090a090a090a090a191a191a191a19090a090a09090a090a090a090a090a090a090a090a090a090a090a090a090a090a09
19191a191a191a191a191a191a191a191a191a191a19191a191a191a191a191a19191a191a191a191a191a191a191a191a191a191a1a191a191a19191a191a191a191a191a191a191a191a191a191a191a191a191a191a191a191a191a19191a191a19191a191a191a191a191a191a191a191a191a191a191a191a191a191a19
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000009
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000009
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000009
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000009
0000090a090a090a00000000000000000000000000000000090a090a090a00000000000000000000000000000000000000090a090a0000090a000000000000000000000000000000000000090a090a000000000000090a090a090a000000090a090a000000000000000000000000090a090a00000000090a0000000000000009
0000191a191a191a00000000000000000000000000000000191a191a191a00000000000000000000000000000000000000191a191a0000191a000000000000000000000000000000000000191a191a000000000000191a191a191a000000191a191a000000000000000000000000191a191a00000000191a0000000000000009
090a090a090a090a090a090a090a090a090a090a090a090a090a090a090a090a090a090a090a09090a090a090a090a090a090a090a090a090a090a090a090a090a090a090a090a090a090a090a090a090a090a090a090a090a090a090a09090a090a090a090a090a090a090a090a090a090a090a090a090a090a090a090a0909
191a191a191a191a191a191a191a191a191a191a191a191a191a191a191a191a191a191a191a19191a191a191a191a191a191a191a191a191a191a191a191a191a191a191a191a191a191a191a191a191a191a191a191a191a191a191a19191a191a191a191a191a191a191a191a191a191a191a191a191a191a191a191a191a
